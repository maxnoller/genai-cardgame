# GenAI Card Game - Design Document

## Overview

A Magic: The Gathering-inspired card game where all cards are dynamically generated by AI. Card text is generated by Google Gemini LLM and card images are generated by Google Nano Banana (Gemini 2.5 Flash Image).

## Tech Stack

- **Frontend**: React with TanStack Router
- **Hosting**: Cloudflare Pages
- **Backend**: Convex (database, real-time sync, auth, file storage, API actions)
- **Card Text Generation**: Google Gemini API
- **Card Image Generation**: Google Nano Banana (`gemini-2.5-flash-image`)
- **Language**: TypeScript (entire stack)

## Core Game Mechanics

### Win Condition
- Each player starts with **100 life points** (EDH-style)
- Reduce opponent's life to 0 to win

### Turn Structure
Standard MTG phases:
1. Untap
2. Upkeep
3. Draw (card is generated at this point)
4. Main Phase 1
5. Combat (declare attackers → declare blockers → damage)
6. Main Phase 2
7. End

### Card Categories
Following MTG archetypes:
- **Creatures** - Have power/toughness, can attack and block
- **Instants** - Can be played at any time, one-time effect
- **Sorceries** - Can only be played on your turn during main phase, one-time effect
- **Enchantments** - Permanents with ongoing effects
- **Artifacts** - Permanents, colorless, various effects
- **Lands** - Generate resources, randomly generated

### Resource System
- Players tap lands to generate mana/resources
- Resource types are **dynamically generated** based on the combined world theme
- Example: If the world is "volcanic underwater temple civilization," resources might be "Magma Essence," "Abyssal Coral," "Sacred Steam"

## Vibe Draft System

### Pre-Game Draft
1. Each player submits **~3 words/phrases** to a shared pool
2. All submissions are shuffled together
3. Players **alternately draft** from the pool (not all words are picked)
4. Each player's drafted words form their **deck theme/vibe**

### World Generation
- After the draft, the LLM generates a **unified world** that combines all drafted themes
- This world defines:
  - The aesthetic/flavor of all cards
  - The resource/mana types available
  - The overall narrative context

### Example
- Player A submits: "volcanic fury", "ancient machines", "forgotten war"
- Player B submits: "deep ocean", "crystal magic", "sleeping gods"
- After draft, Player A has: "volcanic fury", "crystal magic"
- After draft, Player B has: "deep ocean", "ancient machines"
- Generated world: "A civilization of crystalline automatons that harvest volcanic vents beneath the ocean, worshipping dormant machine-gods..."

## Card Generation

### When Cards Are Generated
- Cards are generated **in real-time when drawn**
- Generation is influenced by:
  - The player's drafted vibe/theme
  - Current field state (what's in play)
  - The unified world context

### Card Components (LLM-Generated)
- **Name**: Thematic, fits the world
- **Card Type**: Creature, Instant, Sorcery, Enchantment, Artifact
- **Mana Cost**: Balanced based on power level
- **Abilities**: Selected from hardcoded ability library, flavored by LLM
- **Stats** (for creatures): Power/Toughness
- **Flavor Text**: World-building text

### Stat Balancing
- Cards have a "mana budget" - higher cost = more stat points
- LLM allocates points across attack/defense/abilities
- No strict enforcement initially - emergent balance through indirect player influence

### Rare Surprises
- The system should allow for unexpected, powerful, or unusual cards to emerge
- Boundaries are intentionally lax to enable "crazy things" to happen
- Not hardcoded randomness - emergent from the generation system

## Hardcoded Ability Library

A set of core mechanical effects that the LLM can select and flavor. This ensures cards are mechanically parseable while allowing creative freedom.

### Example Abilities

```typescript
// Damage
DEAL_DAMAGE(target: Target, amount: number)
DEAL_DAMAGE_AOE(targets: Target[], amount: number)

// Healing
HEAL(target: Target, amount: number)
GAIN_LIFE(amount: number)

// Card Manipulation
DRAW_CARDS(amount: number)
DISCARD_CARDS(amount: number)
MILL(target: Player, amount: number)

// Removal
DESTROY(target: Permanent)
EXILE(target: Permanent)
RETURN_TO_HAND(target: Permanent)

// Combat
BUFF_STATS(target: Creature, power: number, toughness: number)
GRANT_KEYWORD(target: Creature, keyword: Keyword)

// Keywords
FLYING, TRAMPLE, HASTE, VIGILANCE, DEATHTOUCH, LIFELINK, FIRST_STRIKE, HEXPROOF

// Field Manipulation
TAP(target: Permanent)
UNTAP(target: Permanent)

// Special
COMBINE_PERMANENTS(permanent1: Permanent, permanent2: Permanent)
COPY(target: Permanent)
COUNTER(target: Spell)

// Resource
ADD_MANA(type: ManaType, amount: number)
```

### LLM Flavoring
The LLM takes a mechanical effect and wraps it in thematic flavor:

**Mechanical**: `DEAL_DAMAGE(target: creature, amount: 3)`

**Flavored Card**:
> **Magma Surge**
> Instant - 2R
> Deal 3 damage to target creature.
> *"The vents erupted without warning, consuming the crystalline scouts in moments."*

## Combination Mechanic

### How It Works
- Players can **combine any two permanents** (creatures, enchantments, artifacts)
- Can combine:
  - Two of your own permanents
  - Your permanent + opponent's permanent (requires specific abilities)
- **Both permanents are destroyed**
- A **new card is generated** based on the combined inputs
- **Output type is unknown** - could be creature, enchantment, artifact, etc.

### Combination Abilities
Certain generated abilities enable combination:
- `COMBINE_PERMANENTS(yours, yours)` - Combine two of your permanents
- `COMBINE_PERMANENTS(yours, theirs)` - Combine with an opponent's permanent

### Example
Combining "Crystalline Sentinel" (3/4 creature with hexproof) + "Volcanic Vent" (artifact that deals 1 damage per turn) might produce:
> **Obsidian Guardian**
> Creature - Golem
> 4/5
> Hexproof
> At the beginning of your upkeep, deal 2 damage to target creature or player.

## Image Generation

### Timing
- Images are generated **in real-time** when cards are drawn
- Uses Google Nano Banana (`gemini-2.5-flash-image`) for speed

### Implementation
- Card text is generated first
- Image prompt is constructed from: card name, type, abilities, world context
- Image is stored in Convex file storage
- Displayed optimistically (show card text while image loads)

## Future Ideas (Not MVP)

### Evolution Mechanic
- Creatures can evolve into stronger forms
- Trigger conditions TBD (survival, cost, field state)

### Luck System
- A "luck" resource judged by a neutral LLM
- Rewards fair play, penalizes exploitative moves
- Can be spent on rerolls, boosts, or blocking actions

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Cloudflare Pages                      │
│  ┌─────────────────────────────────────────────────┐    │
│  │              React + TanStack Router             │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────────────┐ │    │
│  │  │  Game UI │ │  Draft   │ │  Card Display    │ │    │
│  │  │          │ │  Phase   │ │  (images/text)   │ │    │
│  │  └──────────┘ └──────────┘ └──────────────────┘ │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                            │
                            │ Real-time subscriptions
                            ▼
┌─────────────────────────────────────────────────────────┐
│                        Convex                            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐ │
│  │   Database   │ │   Actions    │ │   File Storage   │ │
│  │              │ │              │ │                  │ │
│  │ - Games      │ │ - Generate   │ │ - Card images    │ │
│  │ - Players    │ │   card text  │ │                  │ │
│  │ - Cards      │ │ - Generate   │ │                  │ │
│  │ - Field      │ │   card image │ │                  │ │
│  │ - Draft      │ │ - Combine    │ │                  │ │
│  └──────────────┘ └──────────────┘ └──────────────────┘ │
└─────────────────────────────────────────────────────────┘
                            │
                            │ HTTP requests
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   Google Gemini API                      │
│  ┌──────────────────────┐ ┌────────────────────────┐    │
│  │   Text Generation    │ │   Image Generation     │    │
│  │   (Gemini Pro)       │ │   (Nano Banana)        │    │
│  └──────────────────────┘ └────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

## Database Schema (Convex)

```typescript
// Player
{
  _id: Id<"players">,
  name: string,
  email: string,
  authId: string,
}

// Game
{
  _id: Id<"games">,
  player1: Id<"players">,
  player2: Id<"players">,
  currentTurn: Id<"players">,
  phase: "draft" | "play",
  turnPhase: "untap" | "upkeep" | "draw" | "main1" | "combat" | "main2" | "end",
  player1Life: number,
  player2Life: number,
  worldDescription: string,
  resourceTypes: string[],
  status: "waiting" | "active" | "finished",
  winner?: Id<"players">,
}

// DraftPool
{
  _id: Id<"draftPool">,
  gameId: Id<"games">,
  words: string[],
  player1Picks: string[],
  player2Picks: string[],
  currentPicker: Id<"players">,
}

// Card
{
  _id: Id<"cards">,
  gameId: Id<"games">,
  ownerId: Id<"players">,
  name: string,
  cardType: "creature" | "instant" | "sorcery" | "enchantment" | "artifact" | "land",
  manaCost: string,
  abilities: Ability[],
  power?: number,
  toughness?: number,
  flavorText: string,
  imageUrl?: string,
  location: "hand" | "field" | "graveyard" | "exile",
  tapped: boolean,
}

// Ability (embedded in Card)
{
  mechanicId: string,  // e.g., "DEAL_DAMAGE"
  params: Record<string, any>,  // e.g., { target: "creature", amount: 3 }
  flavoredText: string,  // e.g., "Deal 3 damage to target creature"
}

// FieldState
{
  _id: Id<"fieldState">,
  gameId: Id<"games">,
  playerId: Id<"players">,
  creatures: Id<"cards">[],
  enchantments: Id<"cards">[],
  artifacts: Id<"cards">[],
  lands: Id<"cards">[],
}
```

## MVP Scope

### Included
- [x] Vibe draft system
- [x] World/resource generation from combined themes
- [x] Real-time card generation (text + image)
- [x] MTG-style gameplay (life, combat, turn phases)
- [x] All card types (creature, instant, sorcery, enchantment, artifact, land)
- [x] Hardcoded ability library with LLM flavoring
- [x] Combination mechanic (destroy two permanents, generate new card)
- [x] Online multiplayer with real-time sync
- [x] Basic matchmaking

### Excluded (Future)
- [ ] Evolution mechanic
- [ ] Luck-based balancing system
- [ ] Deck persistence / collection
- [ ] Ranked matchmaking
- [ ] Spectator mode
- [ ] Mobile-optimized UI
